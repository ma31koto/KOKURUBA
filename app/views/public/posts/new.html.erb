<div class="container">
  <div class="row">
    <div class="col-12 mx-auto mt-5">
      <h2><mark class="bg-secondary text-light">スポット投稿</mark></h2>

      <div class="mt-5 offset-1">
        <input id="address" type="textbox" value="" size="50">
        <input type="button" value="地図を検索" onclick="codeAddress()">
        <div id='map' class="mt-3"></div>

        <div class="mt-5 offset-1">
          <%= form_with model:@post, url: posts_path, method: :post, local: true do |f| %>

          <%= f.text_field :longitude, :value => "緯度", id: "longitude" %>
          <%= f.text_field :latitude, :value => "経度", id: "latitude" %>

            <table>
              <thead>
                <tr>
                  <th style="width: 25%"></th>
                  <th style="width: 50%"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><%= f.label :title, "タイトル" %></td>
                  <td><%= f.text_field :title, :placeholder =>"例)東京タワー", size: 50 %></td>
                </tr>
                <tr>
                  <td><%= f.label :introduction, "説明文" %></td>
                  <td><%= f.text_area :introduction, :placeholder =>"例)夜になると外から見ても綺麗ですし、中の展望台から見渡す夜景もとても雰囲気があります！", size: "50x4" %></td>
                </tr>
                <tr>
                  <td><%= f.label :postal_code, "郵便番号" %></td>
                  <td><%= f.text_field :postal_code, :placeholder =>"自動入力", :value => "", id: "postal_code", size: 50 %></td>
                </tr>
                <tr>
                  <td><%= f.label :address, "住所" %></td>
                  <td><%= f.text_field :address, :placeholder =>"自動入力", :value => "", id: "address", size: 50 %></td>
                </tr>
                <tr>
                  <td><%= f.label :area_id, "エリア" %></td>
                  <td><%= f.collection_select :area_id, Area.all, :id, :name, include_blank: "----", class: "form-control", size: 50 %></td>
                </tr>
                <tr>
                  <td><%= f.label :spot_image, "スポット画像" %></td>
                  <td><%= f.file_field :spot_image, accept: "image/*" %></td>
                </tr>
                <tr>
                  <td><%= f.label :name,"タグ (,で区切ると複数タグ登録可能)" %></td>
                  <td><%= f.text_field :name, :placeholder =>"例)夜景,海,イルミネーション", size: 50 %></td>
                </tr>
                <tr>
                  <td>
                    <div class="mt-4">
                      <%= f.label :confession_result, "告白結果" %>
                    </div>
                  </td>
                  <td>
                    <div class="mt-4">
                      <div class="d-flex flex-wrap">
                        <div class="mr-4">
                          <%= f.radio_button :confession_result, Post.confession_results.key(0) %>
                          <%= f.label :confession_result, Post.confession_results_i18n[:yes] %>
                        </div>
                        <div class="mr-4">
                          <%= f.radio_button :confession_result, Post.confession_results.key(1) %>
                          <%= f.label :confession_result, Post.confession_results_i18n[:no] %>
                        </div>
                        <div>
                          <%= f.radio_button :confession_result, Post.confession_results.key(2) %>
                          <%= f.label :confession_result, Post.confession_results_i18n[:no_answer] %>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="mt-4">
                      <div class="mb-2">雰囲気</div>
                      <div class="mb-2">人の少なさ</div>
                      <div class="mb-2">定番度</div>
                      <div class="mb-4">総合評価</div>
                    </div>
                  </td>
                  <td>
                    <div class="mt-4">
                      <div class="star_atmosphere_rate mb-2">
                        <%= f.label :atmosphere_rate %>
                        <%= f.hidden_field :atmosphere_rate %>
                      </div>
                      <div class="star_few_people_rate  mb-2">
                        <%= f.label :few_people_rate %>
                        <%= f.hidden_field :few_people_rate %>
                      </div>
                      <div class="star_standard_rate  mb-2">
                        <%= f.label :standard_rate %>
                        <%= f.hidden_field :standard_rate %>
                      </div>
                      <div class="star_all_rate  mb-4">
                        <%= f.label :all_rate %>
                        <%= f.hidden_field :all_rate %>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td><%= f.submit "投稿", class: "btn btn-primary", style: "width: 150px;" %></td>
                </tr>
              </tbody>
            </table>
            <%#= f.hidden_field :longitude, :value => "", id: "longitude" %>
            <%#= f.hidden_field :latitude, :value => "", id: "latitude" %>
          <% end %>
        </div>

          <script>
            $(document).on('turbolinks:load', function() {
              <% ["atmosphere_rate","few_people_rate","standard_rate","all_rate"].each do |rate| %>
                $('.star_<%= rate %>').empty();
                $('.star_<%= rate %>').raty({
                  size     : 36,
                  starOff:  '<%= asset_path('star-off.png') %>',
                  starOn : '<%= asset_path('star-on.png') %>',
                  starHalf: '<%= asset_path('star-half.png') %>',
                  scoreName: 'post[<%= rate %>]',
                  half: true,
                })
              <% end %>
            })
          </script>
          <script>
            let map
            const longitude = document.getElementById('longitude')
            let markers = []

            // mapの表示関数
            function initMap() {
              geocoder = new google.maps.Geocoder()
             // mapの初期位置, 縮尺を定義
              map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 35.6458437,lng: 139.7046171},
                zoom: 12,
              });

              // mapsテーブルにあるそれぞれのレコードをmap上に表示
              <% @posts.each do |post| %>
                (function(){
                  var contentString = "住所：<%= post.address %>";
                  // マーカーを立てる
                  var marker = new google.maps.Marker({
                    position:{lat: <%= post.latitude %>, lng: <%= post.longitude %>},
                    map: map,
                    title: contentString
                  });
                  markers.push(marker)

                  // 情報ウィンドウ(吹き出し)の定義
                  // 投稿の詳細ページへのリンクも
                  var infowindow = new google.maps.InfoWindow({
                    position: {lat: <%= post.latitude %>, lng: <%= post.longitude %>},
                    content: "<a href='<%=  %>' target='_blank'><%= post.address %></a>"
                  });

                  // クリックしたときに情報ウィンドウを表示
                  // ※(map, marker)の引数なに？marker.なに？
                  marker.addListener('click', function() {
                    infowindow.open(map, marker);
                  });

                })();
              <% end %>


                //クリックしたときの処理
                // function mylistener(event){
                //     marker.setPosition(new google.maps.LatLng(event.latLng.lat(), event.latLng.lng()));
                //     marker.setMap(map);
                //     console.log(event.latLng.lat(), event.latLng.lng());
                //     map_lat.value = event.latLng.lat();
                //     map_lng.value = event.latLng.lng();
                //   }
                // }

                //   function deleteMarker(){
                //     marker.setMap(null);
                //     map_lat.value = "";
                //     map_lng.value = "";
                // }


            }


            let geocoder
             // 地図検索関数
            function codeAddress() {
              let inputAddress = document.getElementById('address').value;

              geocoder.geocode({
                'address': inputAddress},
                function (results, status) {
                  if (status == 'OK') {
                    map.setCenter(results[0].geometry.location);


                    // 再検索でピンを消す
                    function setMapOnAll() {
                      for (let i = 0; i < markers.length; i++) {
                        markers[i].setMap(null);
                      }
                    }

                    var marker = new google.maps.Marker({
                      map: map,
                      position: results[0].geometry.location
                    });
                    markers.push(marker)
                    // 再検索でピンを消す

                    var lat = marker.getPosition().lat();
                    var lng = marker.getPosition().lng();
                    $("#longitude").val(lat);
                    $("#latitude").val(lng);

                    // 郵便番号、住所自動入力
                    // results[0].address_components.reverse().forEach(function(address) {
                    //   if ( value == 1 )
                    //     $("#postal_code").val(value == 1);
                    //   else ( value > 1 )
                    //     var address += value
                    //     $("#address").val(address);
                    // });

                  } else {
                    alert('該当する結果がありませんでした：' + status);
                  }
                });
              }
          </script>

          <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap" async defer></script>

      </div>
    </div>
  </div>
</div>
