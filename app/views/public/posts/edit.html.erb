<div class="container">
  <div class="row">
    <div class="col-12 mx-auto mt-5">
      <h2><mark class="bg-secondary text-light">スポット編集</mark></h2>

      <div class="mt-5 offset-1">
        <input id="address" type="textbox" value="" size="50">
        <input type="button" value="地図を検索" onclick="codeAddress()">
        <div id='map_edit' class="mt-3"></div>

        <div class="mt-5 offset-1">
          <%= form_with model:@post, url: post_path(@post), method: :patch, local: true do |f| %>
            <table>
              <thead>
                <tr>
                  <th style="width: 25%"></th>
                  <th style="width: 50%"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><%= f.label :title, "タイトル" %></td>
                  <td><%= f.text_field :title, :placeholder =>"例)東京タワー", size: 50 %></td>
                </tr>
                <tr>
                  <td><%= f.label :introduction, "説明文" %></td>
                  <td><%= f.text_area :introduction, :placeholder =>"例)夜になると外から見ても綺麗ですし、中の展望台から見渡す夜景もとても雰囲気があります！", size: "50x4" %></td>
                </tr>
                <tr>
                  <td><%= f.label :postal_code, "郵便番号" %></td>
                  <td><%= f.text_field :postal_code, :placeholder =>"自動入力", id: "postal_code", size: 50 %></td>
                </tr>
                <tr>
                  <td><%= f.label :address, "住所" %></td>
                  <td><%= f.text_field :address, :placeholder =>"自動入力", id: "input_address", size: 50 %></td>
                </tr>
                <tr>
                  <td><%= f.label :area_id, "エリア" %></td>
                  <td><%= f.collection_select :area_id, Area.all, :id, :name, include_blank: "----", class: "form-control", size: 50 %></td>
                </tr>
                <tr>
                  <td><%= f.label :spot_image, "スポット画像" %></td>
                  <td><%= f.file_field :spot_image, accept: "image/*" %></td>
                </tr>
                <tr>
                  <td><%= f.label :name,"タグ (,で区切ると複数タグ登録可能)" %></td>
                  <td><%= f.text_field :name, :placeholder =>"例)夜景,海,イルミネーション", :value => @tag_list, size: 50 %></td>
                </tr>
                <tr>
                  <td>
                    <div class="mt-4">
                      <%= f.label :confession_result, "告白結果" %>
                    </div>
                  </td>
                  <td>
                    <div class="mt-4">
                      <div class="d-flex flex-wrap">
                        <div class="mr-4">
                          <%= f.radio_button :confession_result, Post.confession_results.key(0) %>
                          <%= f.label :confession_result, Post.confession_results_i18n[:yes] %>
                        </div>
                        <div class="mr-4">
                          <%= f.radio_button :confession_result, Post.confession_results.key(1) %>
                          <%= f.label :confession_result, Post.confession_results_i18n[:no] %>
                        </div>
                        <div>
                          <%= f.radio_button :confession_result, Post.confession_results.key(2) %>
                          <%= f.label :confession_result, Post.confession_results_i18n[:no_answer] %>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="mt-4">
                      <div>　</div>
                      <div class="mb-2">雰囲気</div>
                      <div class="mb-2">人の少なさ</div>
                      <div class="mb-2">定番度</div>
                      <div class="mb-4">総合評価</div>
                    </div>
                  </td>
                  <td>
                    <div class="mt-4">
                      <div>※平均値ではなくご自身の評価になります。</div>
                      <div class="star_atmosphere_rate mb-2" data-score="<%= @post.atmosphere_rate %>">
                        <%= f.label :atmosphere_rate %>
                        <%= f.hidden_field :atmosphere_rate %>
                      </div>
                      <div class="star_few_people_rate mb-2" data-score="<%= @post.few_people_rate %>">
                        <%= f.label :few_people_rate %>
                        <%= f.hidden_field :few_people_rate %>
                      </div>
                      <div class="star_standard_rate mb-2" data-score="<%= @post.standard_rate %>">
                        <%= f.label :standard_rate %>
                        <%= f.hidden_field :standard_rate %>
                      </div>
                      <div class="star_all_rate mb-4" data-score="<%= @post.all_rate %>">
                        <%= f.label :all_rate %>
                        <%= f.hidden_field :all_rate %>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td>
                    <%= f.submit "変更", class: "btn btn-success mr-3", style: "width: 150px;" %>
                    <%= link_to "削除", post_path(@post),  method: :delete, data: { confirm: '本当に消しますか？' }, class: "btn btn-danger", style: "width: 150px;" %>
                  </td>
                </tr>
              </tbody>
            </table>
            <%= f.hidden_field :longitude, id: "longitude" %>
            <%= f.hidden_field :latitude, id: "latitude" %>
          <% end %>
        </div>

        <script>
          //評価機能
          <% ["atmosphere_rate","few_people_rate","standard_rate","all_rate"].each do |rate| %>
            $('.star_<%= rate %>').empty();
            $('.star_<%= rate %>').raty({
              size     : 36,
              starOff:  '<%= asset_path('star-off.png') %>',
              starOn : '<%= asset_path('star-on.png') %>',
              starHalf: '<%= asset_path('star-half.png') %>',
              scoreName: 'post[<%= rate %>]',
              half: true,
            })
          <% end %>

          //地図機能
          let map_edit
          const longitude = document.getElementById('longitude')
          const latitude = document.getElementById('latitude');
          let marker;
          function formatAddress(results) {
             const formattedAddress = results[0].formatted_address;
            const postalCode = formattedAddress.match(/〒[0-9]{3}-[0-9]{4}/);
            if(!!postalCode) {
              $("#postal_code").val(postalCode[0].slice(1));
            }
            const address = formattedAddress.split('、')[1].split(' ')[1];
            $("#input_address").val(address);
          }

          // mapの表示関数
          function initMap() {
            geocoder = new google.maps.Geocoder()
            marker = new google.maps.Marker();
           // mapの初期位置, 縮尺を定義
            map_edit = new google.maps.Map(document.getElementById('map_edit'), {
              center: {lat: <%= @post.latitude %>,lng: <%= @post.longitude %>},
              zoom: 12,
            });

             // mapsテーブルにあるそれぞれのレコードをmap上に表示
            function showPins(setNull = false){
              var contentString = "住所：<%= @post.address %>";
              // マーカーを立てる
              marker = new google.maps.Marker({
                position:{lat: <%= @post.latitude %>, lng: <%= @post.longitude %>},
                map: map_edit,
                title: contentString
              });
            };
            showPins();

            // クリックしたときの処理
            google.maps.event.addListener(map_edit, 'click', mylistener);
            function mylistener(event){
              const currentLocation = new google.maps.LatLng(event.latLng.lat(), event.latLng.lng());
              marker.setPosition(currentLocation);
              marker.setMap(null);
              marker.setMap(map_edit);
              geocoder.geocode({
                'latLng': currentLocation,
              }, (results, status) => {
                if(status === google.maps.GeocoderStatus.OK) {
                  formatAddress(results);
                } else {
                  alert('何かしらの障害です。')
                }
              });

              latitude.value = event.latLng.lat();
              longitude.value = event.latLng.lng();
            }
          }

           // 地図検索関数
          function codeAddress() {
            let inputAddress = document.getElementById('address').value;

            geocoder.geocode({
              'address': inputAddress},
              function (results, status) {
                if (status == 'OK') {
                  map_edit.setCenter(results[0].geometry.location);

                  // 再検索でピンを消す
                  marker.setMap(null);
                  marker = new google.maps.Marker({
                    map: map_edit,
                    position: results[0].geometry.location
                  });

                  const lat = marker.getPosition().lat();
                  const lng = marker.getPosition().lng();
                  $("#latitude").val(lat);
                  $("#longitude").val(lng);

                  formatAddress(results);

                } else {
                  alert('該当する結果がありませんでした：' + status);
                }
              });
            }
        </script>

        <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap" async defer></script>

      </div>
    </div>
  </div>
</div>
